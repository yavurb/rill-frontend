---
import "@/styles/globals.css";
import Layout from "@/layouts/Layout.astro";
import VideoPlayer from "@/components/VideoPlayer.astro";
import { actions } from "astro:actions";

const { broadcastID = "" } = Astro.params;

const { data: broadcast, error } = await actions.getBroadcast(broadcastID);
if (error || !broadcast) {
  // TODO: Redirect to 404
  console.error("Error getting broadcast", error);

  return Astro.redirect("/broadcasts");
}
---

<Layout title={broadcast?.title || "Viewing..."}>
  <main class="container relative">
    <section>
      <div>
        <VideoPlayer id="rill-player" data-broadcast={`${broadcast.id}`} />
      </div>
    </section>
  </main>
</Layout>

<script>
  const ws = new WebSocket(`${import.meta.env.WS_BACKEND_URL}/broadcasts/ws`);

  ws.onopen = () => {
    console.log("Connected to WebSocket");
  };

  ws.onclose = () => {
    console.log("Disconnected from WebSocket");
  };

  const video = document.getElementById("rill-player") as HTMLVideoElement;
  if (video === null) {
    throw new Error("Video element not found");
  }

  console.log("Joining...");

  const broadcastID = video.dataset.broadcast;
  if (!broadcastID) {
    // TODO: Redirect to 404
    throw new Error("Broadcast ID not found");
  }

  let pc = new RTCPeerConnection({
    iceServers: [
      {
        urls: "stun:stun.l.google.com:19302",
      },
    ],
  });

  ws.onmessage = (event) => {
    const eventData = event.data as string;
    const eventObject: Record<string, any> = JSON.parse(eventData);

    if (eventObject.event === "new-viewer") {
      const { sdp } = eventObject.data;
      console.log(sdp);
      pc.setRemoteDescription(JSON.parse(atob(sdp)));
    }
  };

  pc.oniceconnectionstatechange = (_) => console.log(pc.iceConnectionState);
  pc.onicecandidate = async (event) => {
    if (event.candidate === null) {
      const sd = btoa(JSON.stringify(pc.localDescription));

      const payload = {
        event: "new-viewer",
        data: {
          broadcast_id: broadcastID,
          sdp: sd,
        },
      };

      ws.send(JSON.stringify(payload));
    }
  };

  pc.ontrack = (event) => {
    video.srcObject = event.streams[0];
    video.autoplay = true;
    video.controls = true;
  };

  pc.addTransceiver("video");
  let offer = await pc.createOffer();
  pc.setLocalDescription(offer);
</script>
